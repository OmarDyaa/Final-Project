<button
  class="circle-button"
  (click)="toggleChat()"
  aria-label="Toggle chat assistant"
>
  <span aria-hidden="true">ðŸ’¬</span>
</button>

<div
  *ngIf="isChatVisible"
  class="chat-container"
  role="dialog"
  aria-label="Chat assistant"
>
  <div class="chat-header">
    <h2>Shopping Assistant</h2>
    <button (click)="toggleChat()" aria-label="Close chat">
      <span aria-hidden="true">Ã—</span>
    </button>
  </div>

  <div class="chat-box" #chatBox role="log" aria-live="polite">
    <div
      *ngFor="let chat of chatHistory; trackBy: trackByFn"
      class="message-wrapper"
    >
      <div
        class="message"
        [ngClass]="{
          'user-message': chat.sender === 'User',
          'bot-message': chat.sender === 'Bot'
        }"
      >
        <!-- Product response -->
        <ng-container
          *ngIf="
            chat.sender === 'Bot' &&
            parseProductResponse(chat.message) as product
          "
        >
          <div class="product-card">
            <img
              [src]="product.pictureUrl"
              [alt]="product.name"
              class="product-image"
              loading="lazy"
            />
            <h3>{{ product.name }}</h3>
            <p><strong>Price:</strong> ${{ product.price }}</p>
            <p><strong>Type:</strong> {{ product.type }}</p>
            <p><strong>Brand:</strong> {{ product.brand }}</p>
            <p><strong>Stock:</strong> {{ product.quantityInStock }}</p>
            <p class="product-description">{{ product.description }}</p>
            <button
              class="product-link"
              (click)="navigateToProduct(product.url)"
              [attr.aria-label]="'View details for ' + product.name"
            >
              View Details
            </button>
          </div>
        </ng-container>

        <!-- Regular bot response -->
        <ng-container
          *ngIf="chat.sender === 'Bot' && !parseProductResponse(chat.message)"
        >
          <div
            class="message-text bot-response"
            [innerHTML]="sanitizeMessage(formatBotMessage(chat.message))"
          ></div>
        </ng-container>

        <!-- User message -->
        <ng-container *ngIf="chat.sender === 'User'">
          <div class="message-text user-response">{{ chat.message }}</div>
        </ng-container>
      </div>
    </div>

    <!-- Loading indicator -->
    <div
      *ngIf="isLoading"
      class="message bot-message"
      aria-label="Assistant is typing"
    >
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <!-- Error message -->
    <div *ngIf="errorMessage" class="error" role="alert">
      {{ errorMessage }}
      <button (click)="clearError()" aria-label="Dismiss error">Ã—</button>
    </div>
  </div>

  <div class="input-container">
    <!-- Quick suggestions -->
    <div class="suggestions" *ngIf="!userMessage && !isLoading">
      <button
        *ngFor="let suggestion of suggestions"
        (click)="userMessage = suggestion; sendMessage()"
        [attr.aria-label]="'Try suggestion: ' + suggestion"
      >
        {{ suggestion }}
      </button>
    </div>

    <!-- Message input -->
    <div class="input-group">
      <input
        #chatInput
        [(ngModel)]="userMessage"
        type="text"
        placeholder="Ask about products, prices, or availability..."
        (keyup.enter)="sendMessage()"
        [attr.aria-label]="'Message input'"
        [disabled]="isLoading"
        maxlength="500"
      />
      <button
        (click)="sendMessage()"
        [disabled]="!userMessage.trim() || isLoading"
        aria-label="Send message"
      >
        Send
      </button>
    </div>
  </div>
</div>
